
[toc]

[system](./system.md)

# 服务器

## 常识

* 单台服务器的并发度限制
    * 文件句柄限制
        * `ulimit -n`输出 1024，说明对于一个进程而言最多只能打开1024个文件，所以你要采用此默认配置最多也就可以并发上千个TCP连接。临时修改：ulimit -n 1000000
        * `cat /proc/sys/fs/file-nr` 输出 9344 0 592026，分别为：1. 已经分配的文件句柄数，2. 已经分配但没有使用的文件句柄数，3. 最大文件句柄数。可通过root修改/etc/sysctl.conf完成
    * server最大tcp连接数
        * 每个TCP连接都要占一个端口号。操作系统上端口号1024以下是系统保留的，从1024-65535是用户使用的，所以最多可以有60000多个并发连接。
        * server端tcp连接4元组中只有remote ip（也就是client ip）和remote port（客户端port）是可变的，因此最大tcp连接为**客户端ip数×客户端port数**。
    * 系统资源限制
        * 创建的进程线程多了，数据拷贝频繁（缓存I/O、内核将数据拷贝到用户进程空间、阻塞）， 进程/线程上下文切换消耗大， 导致操作系统崩溃，这就是C10K问题的本质！
        * select解决方案（单线程多连接）：在读取文件句柄之前，先查下它的状态，ready 了就进行处理，不 ready 就不进行处理。缺点：逐个检查状态存在管理上限，只有一个字段记录关注和发生事件。
        * poll解决方案（单线程多连接）：一个 pollfd 数组向内核传递需要关注的事件消除文件句柄上限，同时使用不同字段分别标注关注事件和发生事件，来避免重复初始化。缺点：仍要逐个排查，只不过数量减少。
        * epoll解决方案（单线程多连接）：调用返回的时候只给应用提供发生了状态变化（很可能是数据 ready）的文件句柄。优势：当文件句柄数目达到 10K 的时候，epoll 已经超过 select 和 poll 两个数量级。
    * 参考
        * [高性能网络编程(一)：单台服务器并发TCP连接数到底可以有多少](http://www.52im.net/thread-561-1-1.html)
        * [高性能网络编程(二)：上一个10年，著名的C10K并发连接问题](http://www.52im.net/thread-566-1-1.html)
        * [高性能网络编程(三)：下一个10年，是时候考虑C10M并发问题了](http://www.52im.net/thread-568-1-1.html)
* 典型后端框架
    * ruby on rails：ruby语言
    * node.js：javascript语言，前端后端工程师合二为一
    * nginx：c语言（反向代理服务器）
    * apache：经典后端服务器框架
        * prefork模式，默认模式，使用多个子进程，每个子进程只有一个线程。每个进程在某个确定的时间只能维持一个连接，效率高，但内存占用量比较大。
        * worker模式，使用多个子进程，每个子进程有多个线程，每个线程在某个确定的时间只能维持一个连接，内存占用量比较小，适合高流量的http服务器。（其实没用epoll等方式，同样低效）
    * 差异
        * apache，并发性不足；nginx，反向代理解决并发性，实现完整的http1.1协议；node.js：实现完整的http1.1协议，并发性也够（在这样的情况下，仍然使用反向代理反而降低了效率）；nginx侧重协议层逻辑和性能，nodejs包含协议和逻辑层（php）
        * 什么是反向代理：反向代理（Reverse Proxy）方式是指用代理服务器来接受 internet 上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给 internet 上请求连接的客户端，此时代理服务器对外就表现为一个反向代理服务器。
    * 后端框架设计
        * 考虑要点：线程切换（少）；共享冲突（少）；无锁设计（尽可能）；工作中的线程数尽量等于CPU核心数；逻辑尽量简化，避免不必要的封装和转发
    * 参考：[为什么 Node.js 做的站点可以不用 nginx / Apache 这类 Web server 软件？](https://www.zhihu.com/question/20262642);[8分钟带你深入浅出搞懂Nginx](https://zhuanlan.zhihu.com/p/34943332)