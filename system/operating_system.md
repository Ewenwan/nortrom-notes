
[toc]

[system](./system.md)

# real time opearting system

## concept

* 常见的嵌入式实时操作系统
  * FreeRTOS
  * uc/OS-II
  * RT-Thread：国内实时操作系统，热门
  * VxWorks: 应用于航天、航海、军事领域
* 实时操作系统定义
  * 实时性并非意味着实时操作系统在执行任务时响应速度更快，而是指处理任务的（最迟）完成时间是确定可知的。（[车载实时操作系统与非实时操作系统](https://zhuanlan.zhihu.com/p/84148986))
  * 根据该定义，操作系统可分为：
    * 硬实时操作系统（hard real-time）：完全满足在指定时间内完成关键行为。
    * 软实时操作系统（soft real-time）：大多数情况下在指定时间内完成关键行为。
* 由定义推导设计（[什么是实时操作系统（RTOS）](https://zhuanlan.zhihu.com/p/86861756)）
  * 实时的消息、事件处理机制
    * 一般消息队列都是按照FIFO的方式进行调度，如果有多个接受者，那么接受者也是按照FIFO的原则接受消息，实时操作系统会提供**基于优先级的消息队列处理方式**。
  * 提供内核级的优先级翻转处理方式
    * 实时操作系统调度器最经常遇到的问题就是优先级翻转，因此对于类似信号量一类的API，都能提供**抑止优先级翻转**的机制，防止操作系统死锁。
  * 减少粗粒度的锁和长期关中断的使用
    * **减少影响中断的锁**：自旋锁(spinlock)一类的锁会影响中断，在Windows和Linux的驱动中，为了同步的需要，可能会长期关闭中断，这里的长期可能是毫秒到百微秒级。
    * **中断允许打断**：如果收到一个外部中断，那么操作系统在处理中断的整个过程中可能会一直关中断。但实时操作系统的通常做法是把中断作为一个事件通告给另外一个任务，interrupt handler在处理完关键数据以后，立即打开中断，驱动的中断处理程序以一个高优先级任务的方式继续执行。
  * 系统服务实时
    * 文件系统实时：一般文件系统操作会缓存用户请求，并不直接把数据写入设备，或者建立一系列的线程池，分发文件系统请求。但实时系统中**允许高优先级的任务优先写入数据**，高优先级的请求被优先处理。
    * 优劣：牺牲性能，但换取实时性。需根据场景配置。
  * 避免提供实时性不确定的API
    * **不支持虚拟内存**：多数实时操作系统都不支持虚拟内存（page file/swap area），主要原因是缺页中断（page fault）会导致任务调度的不确定性增加。实时操作系统很多都支持分页，但很少会使用虚拟内存，因为一次缺页中断的开销十分巨大（通常都是毫秒级），波及的代码很多，导致用户程序执行的不确定性增加。
    * **禁用malloc/free**：在某些极端场景下，甚至会禁用动态内存分配（malloc/free），来保证系统不受到动态的任务变化的干扰。
  * 提供针对实时系统调度的专用API
  * 降低系统抖动
    * **控制系统抖动在百纳秒级**：由于关中断等原因，通常情况下，操作系统的调度器不会太精确的产生周期性的调度，比如x86早期的默认60的时钟周期（clock rate），抖动范围可能在15-17ms之间。但一个设计优秀的实时操作系统能把调度器的抖动降低到微秒甚至百纳秒一级，在像x86这种天生抖动就很大的架构上，降低系统抖动尤其重要。
  * 针对实时性设计的SMP和虚拟化技术
* 实时操作系统比较
  * 实时操作系统的实现都十分精简  

    |名称|文档|代码|评价|
    |---|---|---|---|
    |tecentos tiny||||
    |[rt-thread](https://www.rt-thread.org/document/site/)|齐全|精简|参考了Linux的设计思想,支持性号|
    |freertos|||代码严谨度高|
    |liteos||||
    |alios||||
  
  * 参考：[RT-Thread、liteos、TencentOS tiny初学者到底该选择什么RTOS？](https://zhuanlan.zhihu.com/p/79246791)
* 车载实时操作系统
  * uITRON：实时操作系统的一种规范，主要应用于车载领域。比如，uITRON FreeRTOS，满足uITRON规范的FreeRTOS
